<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebAPM Login Button</title>
    <link rel="stylesheet" href="/modules/semantic-ui-css/semantic.min.css">
    <style>
        body { margin: 0; }
        button { border: 0; }
        button {
            border-radius: 0 !important;
        }
    </style>
</head>
<body onload="onLoad()">
<button id="ahriboriLoginButton" class="{{{class}}}" onClick="onClick();"><i class="{{{icon}}}"></i>로그인</button>
<script type="text/javascript">
    var status = 'LOGIN';

    var onLoad = function () {
        var loginButton = document.querySelector('#ahriboriLoginButton');
        window.parent.postMessage(JSON.stringify({
            type: 'createButtonOnload',
            style: {
                width: loginButton.offsetWidth,
                height: loginButton.offsetHeight
            }
        }), '*');

        window.addEventListener('message', function(event) {
            var message = JSON.parse(event.data);
            if (message.type === 'checkTokenValid') {
                // 클라이언트에 저장되어있는 토큰이 유효한 토큰이면
                if (message.success) {
                    setButtonLogout();
                }
            }
        })
    };

    var passResponse = function (response) {
        response.type = 'oncreatebuttonlogin';
        window.parent.postMessage(JSON.stringify(response), "*");
        if (response.success) {
            setButtonLogout();
        }
    };

    var messageEventListenerBinded = false;
    var openLoginPopup = function () {
        window.parent.postMessage(JSON.stringify({
            type: 'getToken',
        }), '*');

        var popup;
        var token;
        var continueURL = encodeURIComponent('{{{continue}}}');
        // 3rd에 token 있을 때 넘어오는 token을 listen
        if (!messageEventListenerBinded) {
            window.addEventListener('message', function(event) {
                var message = JSON.parse(event.data);
                if (message.type === 'token') {
                    token = message.token;
                    popup = window.open('/?clb=1&continue=' + continueURL,'targetWindow',
                        'toolbar=no, location=no, status=no, menubar=no, scrollbars=no, resizable=no, width=360, height=370');
                } else if (message.type === 'popupOnload') {
                    popup.postMessage({
                        type: 'token',
                        token: token
                    }, '*');
                } else if (message.type === 'autologin') {
                    passResponse(message);
                }
            });
            messageEventListenerBinded = true;
        }
    };

    var setButtonLogin = function () {
        var button = document.getElementById('ahriboriLoginButton');
        button.innerHTML = '<i class="privacy icon"></i>로그인';
        status = 'LOGIN';
    };

    var setButtonLogout = function () {
        var button = document.getElementById('ahriboriLoginButton');
        button.innerText = '로그아웃';
        status = 'LOGOUT';
    };

    var logout = function () {
        window.parent.postMessage(JSON.stringify({
            type: 'logout',
        }), '*');
        setButtonLogin();
    };

    var onClick = function () {
        if (status === 'LOGIN') {
            openLoginPopup();
        } else if (status === 'LOGOUT') {
            setButtonLogout();
            logout();
        }
    }
</script>
</body>
</html>